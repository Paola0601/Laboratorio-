-- Querys nuevos para el ejercicio 1 - mariadb2

-- Agregar nuevos registros
-- Insertar nuevos actores
INSERT INTO actores (nombre) VALUES 
('Cillian Murphy'),
('Christian Bale');

-- Insertar nuevas películas
INSERT INTO peliculas (nombre, year, vote, score) VALUES 
('Batman Begins', 2008, 4500, 8.2),
('Oppenheimer', 2023, 12000, 8.7);

-- Relacionar actores con las nuevas películas
INSERT INTO casting (pelicula_id, actor_id, papel) VALUES 
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Batman Begins'), 
 (SELECT actor_id FROM actores WHERE nombre = 'Cillian Murphy'), 'Dr. Jonathan Crane'),
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Batman Begins'), 
 (SELECT actor_id FROM actores WHERE nombre = 'Christian Bale'), 'Bruce Wayne'),
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Oppenheimer'), 
 (SELECT actor_id FROM actores WHERE nombre = 'Cillian Murphy'), 'J. Robert Oppenheimer'),
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Oppenheimer'), 
 (SELECT actor_id FROM actores WHERE nombre = 'Robert Downey Jr.'), 'Lewis Strauss');

-- Borrar registros Scarlett Johansson
DELETE FROM casting 
WHERE actor_id = (SELECT actor_id FROM actores WHERE nombre = 'Scarlett Johansson');

DELETE FROM actores 
WHERE nombre = 'Scarlett Johansson';

-- Eliminar a un repetido y arreglar ids
-- 1. Eliminar el duplicado de Robert Downey Jr.
DELETE FROM actores WHERE actor_id = 9;

-- 2. Renumerar los actor_id en la tabla actores
SET @new_id = 0;
UPDATE actores
SET actor_id = (@new_id := @new_id + 1);

-- 3. Ajustar la tabla casting con los nuevos actor_id
UPDATE casting c
JOIN actores a ON c.actor_id = a.actor_id
SET c.actor_id = a.actor_id;

-- 4. Verificar los cambios
SELECT * FROM actores;
SELECT * FROM casting;

-- Ajustar ids peliculas
-- Renumerar los pelicula_id en la tabla peliculas
SET @new_pelicula_id = 0;
UPDATE peliculas
SET pelicula_id = (@new_pelicula_id := @new_pelicula_id + 1);

-- Ajustar la tabla casting con los nuevos pelicula_id
UPDATE casting c
JOIN peliculas p ON c.pelicula_id = p.pelicula_id
SET c.pelicula_id = p.pelicula_id;

-- Verificar los cambios
SELECT * FROM peliculas;
SELECT * FROM casting;

-- Modificar registros existentes
UPDATE casting 
SET pelicula_id = (SELECT pelicula_id FROM peliculas WHERE nombre = 'Oppenheimer')
WHERE actor_id = (SELECT actor_id FROM actores WHERE nombre = 'Robert Downey Jr.')
  AND papel = 'Iron Man';

UPDATE peliculas 
SET nombre = 'Thor: Love and Thunder', year = 2022, vote = 4300, score = 6.4
WHERE nombre = 'Thor';

-- Relacionar a Christian Bale con "Thor: Love and Thunder"
INSERT INTO casting (pelicula_id, actor_id, papel) VALUES 
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Thor: Love and Thunder'), 
 (SELECT actor_id FROM actores WHERE nombre = 'Christian Bale'), 'Gorr the God Butcher');

-- Debido a errores se elimina la tabla casting y se reintroducen los nuevos registros
DELETE FROM casting;

-- Relacionar actores y películas correctamente
INSERT INTO casting (pelicula_id, actor_id, papel) VALUES
-- Avengers: Endgame
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Avengers: Endgame'),
 (SELECT actor_id FROM actores WHERE nombre = 'Robert Downey Jr.'), 'Iron Man'),
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Avengers: Endgame'),
 (SELECT actor_id FROM actores WHERE nombre = 'Chris Hemsworth'), 'Thor'),

-- Iron Man
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Iron Man'),
 (SELECT actor_id FROM actores WHERE nombre = 'Robert Downey Jr.'), 'Iron Man'),

-- Thor: Love and Thunder
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Thor: Love and Thunder'),
 (SELECT actor_id FROM actores WHERE nombre = 'Chris Hemsworth'), 'Thor'),

-- Batman Begins
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Batman Begins'),
 (SELECT actor_id FROM actores WHERE nombre = 'Christian Bale'), 'Bruce Wayne'),
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Batman Begins'),
 (SELECT actor_id FROM actores WHERE nombre = 'Cillian Murphy'), 'Dr. Jonathan Crane'),

-- Oppenheimer
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Oppenheimer'),
 (SELECT actor_id FROM actores WHERE nombre = 'Cillian Murphy'), 'J. Robert Oppenheimer'),
((SELECT pelicula_id FROM peliculas WHERE nombre = 'Oppenheimer'),
 (SELECT actor_id FROM actores WHERE nombre = 'Robert Downey Jr.'), 'Lewis Strauss');

-- Reiniciar los ids de casting
-- 1. Crear una copia temporal de la tabla casting
CREATE TEMPORARY TABLE temp_casting AS SELECT * FROM casting;

-- 2. Eliminar la tabla casting original
DROP TABLE casting;

-- 3. Volver a crear la tabla casting
CREATE TABLE casting (
    casting_id INT PRIMARY KEY AUTO_INCREMENT,
    pelicula_id INT,
    actor_id INT,
    papel VARCHAR(100),
    FOREIGN KEY (pelicula_id) REFERENCES peliculas(pelicula_id) ON DELETE CASCADE,
    FOREIGN KEY (actor_id) REFERENCES actores(actor_id) ON DELETE CASCADE
);

-- 4. Insertar los datos de la tabla temporal en la nueva tabla casting
INSERT INTO casting (pelicula_id, actor_id, papel)
SELECT pelicula_id, actor_id, papel FROM temp_casting;

-- 5. Eliminar la tabla temporal
DROP TABLE temp_casting;

-- 6. Verificar los resultados
SELECT * FROM casting;

--Cambiando un actor repetido 
UPDATE actores
SET nombre = 'Liam Hemsworth'
WHERE actor_id = 3;
